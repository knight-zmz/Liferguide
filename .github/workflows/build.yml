name: Build and Deploy

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'lifeguide.tex'
      - 'media/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

# GitHub Pages æ‰€éœ€æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # å®‰è£… TeX Liveï¼ˆå« XeLaTeX ä¸ ctex ç›¸å…³å®åŒ…ï¼‰
    - name: Setup TeX Live
      uses: zauguin/install-texlive@v3
      with:
        packages: scheme-full

    # ç¬¬ä¸€æ¬¡ç¼–è¯‘ï¼šç”Ÿæˆç›®å½•ä¸è¾…åŠ©æ–‡ä»¶
    - name: Compile LaTeX to PDF (Pass 1 - Generate TOC)
      run: |
        echo "ğŸ”¨ First pass: Building table of contents..."
        xelatex -interaction=nonstopmode -shell-escape lifeguide.tex || true
      continue-on-error: true

    # ç¬¬äºŒæ¬¡ç¼–è¯‘ï¼šç”Ÿæˆæ­£ç¡®é¡µç çš„æœ€ç»ˆ PDF
    - name: Compile LaTeX to PDF (Pass 2 - Final Output)
      run: |
        echo "ğŸ”¨ Second pass: Building final PDF with correct page numbers..."
        xelatex -interaction=nonstopmode -shell-escape lifeguide.tex || true
      continue-on-error: true

    # æ£€æŸ¥ PDF æ˜¯å¦ç”ŸæˆæˆåŠŸï¼ˆå¤±è´¥ä¸é˜»æ–­åç»­æ­¥éª¤ï¼‰
    - name: Check PDF generation
      run: |
        if [ -f lifeguide.pdf ]; then
          echo "âœ“ PDF generated successfully"
          ls -lh lifeguide.pdf
        else
          echo "âœ— PDF generation failed - but continuing deployment"
          exit 0
        fi

    # å¯é€‰ï¼šä½¿ç”¨ tex4ht ç”Ÿæˆ HTMLï¼ˆå¤±è´¥ä¸é˜»æ–­ï¼‰
    - name: Convert LaTeX to HTML with tex4ht (Optional)
      run: |
        mkdir -p build/html
        if command -v make4ht &> /dev/null; then
          echo "âœ“ tex4ht found - converting to HTML..."
          make4ht -u -x -f html5 -d build/html lifeguide.tex 2>&1 || true
          echo "âœ“ HTML conversion completed"
        else
          echo "âŠ˜ tex4ht not found - HTML conversion skipped (optional)"
        fi
      continue-on-error: true

    # æ³¨å…¥è‡ªå®šä¹‰ CSSï¼Œå¹¶æŠŠç›®å½•æå‡ä¸ºä¾§è¾¹æ 
    - name: Add HTML styling and sidebar
      run: |
        if [ -d build/html ]; then
          cp web/lifeguide.css build/html/lifeguide.css
          for f in build/html/*.html; do
            if [ -f "$f" ] && ! grep -q "lifeguide.css" "$f"; then
              sed -i 's#</head>#  <link rel="stylesheet" href="lifeguide.css" />\n</head>#' "$f"
            fi
          done
          python3 web/postprocess_html.py build/html
        fi

    # ç”Ÿæˆé™æ€é¦–é¡µï¼ˆç”¨äº GitHub Pages å…¥å£ï¼‰
    - name: Create index.html for GitHub Pages
      run: |
        mkdir -p build
        cat > build/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>æœ¬ç§‘å‡å­¦è·¯å¾„æŒ‡å— - Liferguide</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
              line-height: 1.6;
              color: #333;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              min-height: 100vh;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }
            .container {
              background: white;
              border-radius: 10px;
              box-shadow: 0 10px 40px rgba(0,0,0,0.1);
              padding: 60px 40px;
              max-width: 900px;
              text-align: center;
            }
            h1 {
              color: #365f91;
              font-size: 2.5em;
              margin-bottom: 0.3em;
              font-weight: 700;
            }
            .subtitle {
              color: #764ba2;
              font-size: 1.3em;
              margin-bottom: 30px;
              font-weight: 500;
            }
            .description {
              color: #555;
              font-size: 1.1em;
              margin-bottom: 40px;
              line-height: 1.8;
            }
            .buttons {
              display: flex;
              gap: 20px;
              justify-content: center;
              flex-wrap: wrap;
            }
            .btn {
              display: inline-block;
              padding: 15px 40px;
              border-radius: 5px;
              text-decoration: none;
              font-size: 1.1em;
              font-weight: 600;
              transition: all 0.3s ease;
              border: 2px solid;
            }
            .btn-primary {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border-color: transparent;
            }
            .btn-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            }
            .btn-secondary {
              background: white;
              color: #667eea;
              border-color: #667eea;
            }
            .btn-secondary:hover {
              background: #667eea;
              color: white;
              transform: translateY(-2px);
            }
            .features {
              margin-top: 50px;
              text-align: left;
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 30px;
            }
            .feature {
              background: #f8f9fa;
              padding: 20px;
              border-radius: 8px;
              border-left: 4px solid #667eea;
            }
            .feature h3 {
              color: #365f91;
              margin-bottom: 10px;
              font-size: 1.1em;
            }
            .feature p {
              color: #666;
              font-size: 0.95em;
            }
            .footer {
              margin-top: 50px;
              padding-top: 30px;
              border-top: 1px solid #eee;
              color: #999;
              font-size: 0.9em;
            }
            @media (max-width: 600px) {
              .container { padding: 40px 20px; }
              h1 { font-size: 1.8em; }
              .subtitle { font-size: 1.1em; }
              .features { grid-template-columns: 1fr; }
              .buttons { flex-direction: column; }
              .btn { width: 100%; }
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>ğŸ“š æœ¬ç§‘å‡å­¦è·¯å¾„æŒ‡å—</h1>
            <p class="subtitle">ä¸ºå‰å¤§ç”Ÿç§‘æˆé•¿èµ‹èƒ½</p>
            <p class="description">
              å®Œæ•´çš„æœ¬ç§‘å‡å­¦æŒ‡å—ï¼Œæ¶µç›–ä¿ç ”å’Œè€ƒç ”ä¸¤å¤§å‡å­¦è·¯å¾„ï¼ŒåŒ…å«æ”¿ç­–è§£è¯»ã€æµç¨‹åˆ†æåŠå­¦é•¿å­¦å§ç»éªŒåˆ†äº«ã€‚åœ¨è¿™æœ¬æŒç»­æ›´æ–°çš„ç”µå­æŒ‡å—ä¸­ï¼Œæ‰¾åˆ°å±äºä½ çš„å‡å­¦æ–¹å‘ã€‚
            </p>
            <div class="buttons">
              <a href="lifeguide.pdf" class="btn btn-primary">ğŸ“– ä¸‹è½½ PDF ç‰ˆæœ¬</a>
              <a href="html/lifeguide.html" class="btn btn-secondary">ğŸŒ åœ¨çº¿é˜…è¯»</a>
              <a href="https://github.com/knight-zmz/Liferguide" class="btn btn-secondary">ğŸ’» GitHub</a>
            </div>
            <div class="features">
              <div class="feature">
                <h3>ä¿ç ”æŒ‡å—</h3>
                <p>è¯¦ç»†çš„ä¿ç ”æµç¨‹ã€åé¢åˆ†æã€å¯¼å¸ˆé€‰æ‹©ã€è”ç³»ç­–ç•¥ç­‰å®Œæ•´æŒ‡å—</p>
              </div>
              <div class="feature">
                <h3>è€ƒç ”æŒ‡å—</h3>
                <p>è€ƒç ”æ–¹å‘ã€é™¢æ ¡é€‰æ‹©ã€å¤‡è€ƒå»ºè®®ç­‰å†…å®¹æŒç»­æ›´æ–°ä¸­</p>
              </div>
              <div class="feature">
                <h3>ç»éªŒåˆ†äº«</h3>
                <p>æ¥è‡ª 20+ ä½å­¦é•¿å­¦å§çš„çœŸå®ç»å†å’Œå®è·µå»ºè®®</p>
              </div>
              <div class="feature">
                <h3>æŒç»­æ›´æ–°</h3>
                <p>æ¯å¹´æ›´æ–°å†…å®¹ï¼Œæ¬¢è¿æäº¤åé¦ˆå’Œæ–°ç»éªŒ</p>
              </div>
            </div>
            <div class="footer">
              <p>Liferguide Â© 2024-2026 | å‰æ—å¤§å­¦ç”Ÿå‘½ç§‘å­¦å­¦é™¢ | <a href="https://github.com/knight-zmz/Liferguide" style="color: #667eea;">GitHub Repository</a></p>
              <p>æ­¤èµ„æ–™ä»…ä¾›å­¦é™¢å†…éƒ¨äº¤æµä½¿ç”¨ï¼Œä¸ç”¨äºå•†ä¸šç”¨é€”ã€‚</p>
            </div>
          </div>
        </body>
        </html>
        EOF
        echo "âœ“ Index page created"

    # å°† PDF æ”¾å…¥å‘å¸ƒç›®å½•
    - name: Copy PDF to build directory
      run: |
        if [ -f lifeguide.pdf ]; then
          cp lifeguide.pdf build/
          echo "âœ“ PDF copied to build directory"
          ls -lh build/lifeguide.pdf
        else
          echo "âŠ˜ Warning: PDF not found, but continuing deployment"
        fi
      continue-on-error: true

    # è¾“å‡ºå‘å¸ƒç›®å½•å†…å®¹ï¼Œä¾¿äºæ’æŸ¥
    - name: List build directory contents
      run: |
        echo "ğŸ“¦ Build directory contents:"
        ls -la build/

    # ä¸Šä¼  Pages æ„å»ºäº§ç‰©
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
